---
# Master playbook: Twingate + AAP Access Provisioning
#
# This playbook orchestrates the complete user provisioning workflow:
# 1. Create users in Twingate from CSV
# 2. Grant AAP job template execute access to those users
#
# Prerequisites:
#   - TWINGATE_API_KEY environment variable set
#   - TOWER_HOST, TOWER_OAUTH_TOKEN (or TOWER_USERNAME/TOWER_PASSWORD) environment variables set
#   - CSV file with user data (default: data/usernames-devqe.csv)
#   - AAP template names configured
#
# Usage:
#   export TWINGATE_API_KEY=your_twingate_key
#   export TOWER_HOST=https://your-aap.com
#   export TOWER_OAUTH_TOKEN=your_aap_token
#
#   ansible-playbook playbooks/main.yml \
#     -e "csv_path={{ playbook_dir }}/../data/usernames-devqe.csv" \
#     -e "aap_template_names=Template1,Template2"
#
# Or run individual components:
#   ansible-playbook playbooks/twingate_create_users.yml
#   ansible-playbook playbooks/aap_grant_access.yml -e "username=user@example.com" -e "template_name=MyTemplate"

- name: Twingate User Creation
  import_playbook: twingate_create_users.yml
  tags: [twingate, users]

- name: AAP Access Grant (batch mode)
  hosts: localhost
  gather_facts: false
  collections:
    - awx.awx

  vars_files:
    - ../inventory/group_vars/all.yml

  vars:
    # CSV path default - can be overridden via -e csv_path=...
    default_csv_path: "{{ playbook_dir }}/../data/usernames-devqe.csv"
    # csv_line: Single CSV line to process instead of file, set via -e csv_line='...'
    # aap_template_names: Comma-separated template names, set via -e aap_template_names='...'
    # Note: csv_line and aap_template_names not defined here to allow passthrough from -e

  pre_tasks:
    - name: Debug csv_line before sanitization
      ansible.builtin.debug:
        var: csv_line
      when:
        - csv_line is defined
        - csv_line | length > 0
      tags: [twingate, aap, access]

    - name: Detect if csv_line has echo wrapper
      ansible.builtin.set_fact:
        has_echo_wrapper: "{{ 'echo' in csv_line }}"
      when:
        - csv_line is defined
        - csv_line | length > 0
      tags: [twingate, aap, access]

    - name: Extract CSV data from echo command (split by single quote)
      ansible.builtin.set_fact:
        csv_data_parts: "{{ csv_line.split(\"'\") }}"
      when:
        - csv_line is defined
        - csv_line | length > 0
        - has_echo_wrapper | default(false) | bool
      tags: [twingate, aap, access]

    - name: Set csv_line_sanitized to extracted value (if echo wrapper detected)
      ansible.builtin.set_fact:
        csv_line_sanitized: "{{ csv_data_parts[1] }}"
      when:
        - csv_data_parts is defined
        - csv_data_parts | length > 1
      tags: [twingate, aap, access]

    - name: Set csv_line_sanitized to original value (if no echo wrapper)
      ansible.builtin.set_fact:
        csv_line_sanitized: "{{ csv_line }}"
      when:
        - csv_line is defined
        - csv_line | length > 0
        - not (has_echo_wrapper | default(false) | bool)
      tags: [twingate, aap, access]

    - name: Debug csv_line_sanitized after sanitization
      ansible.builtin.debug:
        var: csv_line_sanitized
      when:
        - csv_line_sanitized is defined
        - csv_line_sanitized | length > 0
      tags: [twingate, aap, access]

  tasks:
    - name: Check if CSV file exists
      ansible.builtin.stat:
        path: "{{ csv_path | default(default_csv_path) }}"
      register: aap_csv_file_stat
      when:
        - (aap_template_names | default('') | length) > 0
        - (csv_line | default('') | length) == 0
      tags: [aap, access]

    - name: Validate AAP input source
      ansible.builtin.assert:
        that:
          - ((csv_line | default('') | length) > 0) or (aap_csv_file_stat.stat.exists | default(false))
        fail_msg: |
          No CSV input found for AAP access grants. Please provide either:
          - A CSV file at: {{ csv_path | default(default_csv_path) }}
          - Or inline CSV data via: -e 'csv_line=username,email,DEVQE,First,Last,GroupName,DPP-00000'
      when:
        - (aap_template_names | default('') | length) > 0
        - (csv_line | default('') | length) == 0
      tags: [aap, access]

    - name: Read CSV file
      ansible.builtin.set_fact:
        csv_lines: "{{ lookup('file', csv_path | default(default_csv_path)).split('\n') }}"
      when:
        - (aap_template_names | default('') | length) > 0
        - (csv_line | default('') | length) == 0
        - aap_csv_file_stat.stat.exists
      tags: [aap, access]

    - name: Use inline CSV line
      ansible.builtin.set_fact:
        csv_lines: "{{ [csv_line_sanitized | default(csv_line) | default('')] }}"
      when:
        - (aap_template_names | default('') | length) > 0
        - (csv_line | default('') | length) > 0
      tags: [aap, access]

    - name: Extract usernames from CSV for AAP
      ansible.builtin.set_fact:
        aap_usernames: "{{ aap_usernames | default([]) + [item.split(',')[0]] }}"
      loop: "{{ csv_lines }}"
      when:
        - (aap_template_names | default('') | length) > 0
        - csv_lines is defined
        - item | length > 0
        - item.split(',') | length > 0
        - item.split(',')[0] | length > 0
      tags: [aap, access]

    - name: Grant AAP template execute access to all users
      ansible.builtin.include_tasks: aap_grant_access_task.yml
      loop: "{{ aap_usernames }}"
      loop_control:
        loop_var: aap_username
      when:
        - (aap_template_names | default('') | length) > 0
        - aap_usernames is defined
        - aap_usernames | length > 0
      tags: [aap, access]
