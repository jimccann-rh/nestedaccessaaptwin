---
# Task file: Close Jira ticket with comment
#
# This task adds a comment to a Jira ticket documenting user provisioning,
# then transitions it to a closed state.
#
# Required variables:
#   - jira_ticket_id: The ticket ID (e.g., DPP-00000)
#   - jira_base_url: Base Jira URL (e.g., https://issues.redhat.com)
#   - jira_email: Email for API authentication
#   - jira_api_token: API token for authentication
#   - username: Username that was provisioned
#   - user_email: Email of user that was provisioned

- name: "Add comment to Jira ticket {{ jira_ticket_id }}"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/comment"
    method: POST
    user: "{{ jira_email }}"
    password: "{{ jira_api_token }}"
    force_basic_auth: true
    body_format: json
    body:
      body: |
        User provisioning completed successfully via Ansible automation:
        * Username: {{ username }}
        * Email: {{ user_email }}
        * Twingate user created and added to group
        * AAP job template execute permissions granted

        Automated by: {{ lookup('env', 'USER') | default('ansible') }}
        Timestamp: {{ ansible_date_time.iso8601 }}
    status_code: [201]
    headers:
      Content-Type: "application/json"
  register: jira_comment_result
  failed_when: false
  no_log: "{{ jira_no_log | default(true) }}"

- name: "Get available transitions for {{ jira_ticket_id }}"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/transitions"
    method: GET
    user: "{{ jira_email }}"
    password: "{{ jira_api_token }}"
    force_basic_auth: true
    status_code: [200]
    headers:
      Content-Type: "application/json"
  register: jira_transitions_result
  failed_when: false
  when: jira_comment_result.status | default(0) == 201
  no_log: "{{ jira_no_log | default(true) }}"

- name: "Find close/done transition ID for {{ jira_ticket_id }}"
  ansible.builtin.set_fact:
    close_transition_id: >-
      {{
        jira_transitions_result.json.transitions
        | selectattr('name', 'match', '(?i)(close|done|resolve)')
        | map(attribute='id')
        | first
        | default('')
      }}
  when:
    - jira_transitions_result.status | default(0) == 200
    - jira_transitions_result.json.transitions is defined

- name: "Transition {{ jira_ticket_id }} to closed state"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/transitions"
    method: POST
    user: "{{ jira_email }}"
    password: "{{ jira_api_token }}"
    force_basic_auth: true
    body_format: json
    body:
      transition:
        id: "{{ close_transition_id }}"
    status_code: [204]
    headers:
      Content-Type: "application/json"
  register: jira_transition_result
  failed_when: false
  when:
    - close_transition_id is defined
    - close_transition_id | length > 0
  no_log: "{{ jira_no_log | default(true) }}"

- name: "Report success for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: "Successfully updated Jira ticket {{ jira_ticket_id }} - comment added and ticket closed"
  when:
    - jira_comment_result.status | default(0) == 201
    - jira_transition_result.status | default(0) == 204

- name: "Report partial success for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: "WARNING: Jira ticket {{ jira_ticket_id }} - comment added but could not close ticket (no matching transition found)"
  when:
    - jira_comment_result.status | default(0) == 201
    - (close_transition_id | default('') | length) == 0

- name: "Report failure for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: "WARNING: Failed to update Jira ticket {{ jira_ticket_id }} - {{ jira_comment_result.msg | default('unknown error') }}"
  when: jira_comment_result.status | default(0) != 201
