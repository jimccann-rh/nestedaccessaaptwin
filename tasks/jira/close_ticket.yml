---
# Task file: Close Jira ticket with comment
#
# This task adds a comment to a Jira ticket documenting user provisioning,
# then transitions it to a closed state.
#
# Supports two authentication methods (checked in priority order):
#   1. Personal Access Token (PAT): jira_pat
#   2. Email + API Token: jira_email + jira_api_token
#
# Required variables:
#   - jira_ticket_id: The ticket ID (e.g., DPP-00000)
#   - jira_base_url: Base Jira URL (e.g., https://issues.redhat.com)
#   - username: Username that was provisioned
#   - user_email: Email of user that was provisioned
#
# Authentication (one of):
#   - jira_pat: Personal Access Token (preferred for Jira Data Center/Server)
#   - jira_email + jira_api_token: Email and API token (for Jira Cloud)

- name: "Determine Jira authentication method for {{ jira_ticket_id }}"
  ansible.builtin.set_fact:
    jira_use_pat: "{{ (jira_pat is defined) and (jira_pat | length > 0) }}"

- name: "Debug authentication method for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: "Using {{ 'Personal Access Token (PAT)' if jira_use_pat else 'Email + API Token' }} authentication"

# PAT Authentication Method
- name: "Add comment to Jira ticket {{ jira_ticket_id }} (using PAT)"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/comment"
    method: POST
    body_format: json
    body:
      body: |
        User provisioning completed successfully via Ansible automation:
        * Username: {{ username }}
        * Email: {{ user_email }}
        * Twingate user added and email invite sent
        * AAP job template execute permissions granted

        Automated by: {{ lookup('env', 'USER') | default('ansible') }}
        Timestamp: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
    status_code: [201]
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ jira_pat }}"
  register: jira_comment_result_pat
  failed_when: false
  when: jira_use_pat | bool
  #no_log: "{{ jira_no_log | default(true) }}"

# Email + API Token Authentication Method
- name: "Add comment to Jira ticket {{ jira_ticket_id }} (using Email + API Token)"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/comment"
    method: POST
    user: "{{ jira_email }}"
    password: "{{ jira_api_token }}"
    force_basic_auth: true
    body_format: json
    body:
      body: |
        User provisioning completed successfully via Ansible automation:
        * Username: {{ username }}
        * Email: {{ user_email }}
        * Twingate user added and email invite sent
        * AAP job template execute permissions granted

        Automated by: {{ lookup('env', 'USER') | default('ansible') }}
        Timestamp: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
    status_code: [201]
    headers:
      Content-Type: "application/json"
  register: jira_comment_result_basic
  failed_when: false
  when: not (jira_use_pat | bool)
  #no_log: "{{ jira_no_log | default(true) }}"

- name: "Combine comment results for {{ jira_ticket_id }}"
  ansible.builtin.set_fact:
    jira_comment_result: "{{ jira_comment_result_pat if jira_use_pat else jira_comment_result_basic }}"

- name: "Debug comment result for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: |
      Status: {{ jira_comment_result.status | default('NO STATUS') }}
      Message: {{ jira_comment_result.msg | default('NO MESSAGE') }}
      {% if jira_comment_result.status | default(0) != 201 %}
      Error Details: {{ jira_comment_result.json | default(jira_comment_result.content | default('NO DETAILS')) }}
      {% endif %}

# Get transitions - PAT
- name: "Get available transitions for {{ jira_ticket_id }} (using PAT)"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/transitions"
    method: GET
    status_code: [200]
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ jira_pat }}"
  register: jira_transitions_result_pat
  failed_when: false
  when:
    - jira_use_pat | bool
    - jira_comment_result.status | default(0) == 201
  no_log: "{{ jira_no_log | default(true) }}"

# Get transitions - Email + API Token
- name: "Get available transitions for {{ jira_ticket_id }} (using Email + API Token)"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/transitions"
    method: GET
    user: "{{ jira_email }}"
    password: "{{ jira_api_token }}"
    force_basic_auth: true
    status_code: [200]
    headers:
      Content-Type: "application/json"
  register: jira_transitions_result_basic
  failed_when: false
  when:
    - not (jira_use_pat | bool)
    - jira_comment_result.status | default(0) == 201
  no_log: "{{ jira_no_log | default(true) }}"

- name: "Combine transitions results for {{ jira_ticket_id }}"
  ansible.builtin.set_fact:
    jira_transitions_result: "{{ jira_transitions_result_pat if jira_use_pat else jira_transitions_result_basic }}"
  when: jira_comment_result.status | default(0) == 201

- name: "Find close/done transition ID for {{ jira_ticket_id }}"
  ansible.builtin.set_fact:
    close_transition_id: >-
      {{
        jira_transitions_result.json.transitions
        | selectattr('name', 'match', '(?i)(close|done|resolve)')
        | map(attribute='id')
        | first
        | default('')
      }}
  when:
    - jira_transitions_result.status | default(0) == 200
    - jira_transitions_result.json.transitions is defined

# Transition to closed - PAT
- name: "Transition {{ jira_ticket_id }} to closed state (using PAT)"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/transitions"
    method: POST
    body_format: json
    body:
      transition:
        id: "{{ close_transition_id }}"
    status_code: [204]
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ jira_pat }}"
  register: jira_transition_result_pat
  failed_when: false
  when:
    - jira_use_pat | bool
    - close_transition_id is defined
    - close_transition_id | length > 0
  no_log: "{{ jira_no_log | default(true) }}"

# Transition to closed - Email + API Token
- name: "Transition {{ jira_ticket_id }} to closed state (using Email + API Token)"
  ansible.builtin.uri:
    url: "{{ jira_base_url }}/rest/api/2/issue/{{ jira_ticket_id }}/transitions"
    method: POST
    user: "{{ jira_email }}"
    password: "{{ jira_api_token }}"
    force_basic_auth: true
    body_format: json
    body:
      transition:
        id: "{{ close_transition_id }}"
    status_code: [204]
    headers:
      Content-Type: "application/json"
  register: jira_transition_result_basic
  failed_when: false
  when:
    - not (jira_use_pat | bool)
    - close_transition_id is defined
    - close_transition_id | length > 0
  no_log: "{{ jira_no_log | default(true) }}"

- name: "Combine transition results for {{ jira_ticket_id }}"
  ansible.builtin.set_fact:
    jira_transition_result: "{{ jira_transition_result_pat if jira_use_pat else jira_transition_result_basic }}"
  when:
    - close_transition_id is defined
    - close_transition_id | length > 0

- name: "Report success for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: "Successfully updated Jira ticket {{ jira_ticket_id }} - comment added and ticket closed"
  when:
    - jira_comment_result.status | default(0) == 201
    - jira_transition_result.status | default(0) == 204

- name: "Report partial success for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: "WARNING: Jira ticket {{ jira_ticket_id }} - comment added but could not close ticket (no matching transition found)"
  when:
    - jira_comment_result.status | default(0) == 201
    - (close_transition_id | default('') | length) == 0

- name: "Report failure for {{ jira_ticket_id }}"
  ansible.builtin.debug:
    msg: |
      WARNING: Failed to update Jira ticket {{ jira_ticket_id }}
      Status Code: {{ jira_comment_result.status | default('NO STATUS') }}
      Error: {{ jira_comment_result.msg | default('unknown error') }}
      {% if jira_comment_result.json is defined %}
      Details: {{ jira_comment_result.json }}
      {% endif %}
  when: jira_comment_result.status | default(0) != 201
